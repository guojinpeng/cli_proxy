<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLI Proxy 状态监控</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.8.0/dist/index.css">
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="app" v-cloak>
        <div class="container">
            <header>
                <h1>CLI Proxy 状态监控</h1>
                <div class="refresh-info">
                    <span>{{ lastUpdate }}</span>
                    <el-button type="primary" @click="refreshData" :loading="loading" size="small" style="margin-left:8px">
                        刷新
                    </el-button>
                    <el-button @click="openAuthSettings" size="small" style="margin-left:8px">
                        鉴权设置
                    </el-button>
                    <el-button type="danger" @click="logout" size="small" style="margin-left:8px">
                        退出登录
                    </el-button>
                </div>
            </header>

            <main>
                <!-- 服务状态卡片 -->
                <section class="services-section">
                    <h2>代理服务状态</h2>
                    <div class="services-grid">
                        <div class="service-card">
                            <h3>Claude 服务</h3>
                            <div class="status-indicator">
                                <span :class="['status-dot', services.claude.running ? 'running' : 'stopped']"></span>
                                <span class="status-text">{{ services.claude.running ? '运行中' : '已停止' }}</span>
                            </div>
                            <div class="service-info">
                                <p><strong>PID:</strong> <span>{{ services.claude.pid || '-' }}</span></p>
                                <p><strong>转发目标:</strong> 
                                    <el-select 
                                        v-model="services.claude.config" 
                                        placeholder="选择配置..."
                                        @change="switchConfig('claude', $event)"
                                        size="small"
                                        style="width: 150px;">
                                        <el-option 
                                            v-for="config in claudeConfigs" 
                                            :key="config" 
                                            :label="config" 
                                            :value="config">
                                        </el-option>
                                    </el-select>
                                </p>
                                <p><strong>端口:</strong> 3210</p>
                            </div>
                        </div>

                        <div class="service-card">
                            <h3>Codex 服务</h3>
                            <div class="status-indicator">
                                <span :class="['status-dot', services.codex.running ? 'running' : 'stopped']"></span>
                                <span class="status-text">{{ services.codex.running ? '运行中' : '已停止' }}</span>
                            </div>
                            <div class="service-info">
                                <p><strong>PID:</strong> <span>{{ services.codex.pid || '-' }}</span></p>
                                <p><strong>转发目标:</strong> 
                                    <el-select 
                                        v-model="services.codex.config" 
                                        placeholder="选择配置..."
                                        @change="switchConfig('codex', $event)"
                                        size="small"
                                        style="width: 150px;">
                                        <el-option 
                                            v-for="config in codexConfigs" 
                                            :key="config" 
                                            :label="config" 
                                            :value="config">
                                        </el-option>
                                    </el-select>
                                </p>
                                <p><strong>端口:</strong> 3211</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 统计信息 -->
                <section class="stats-section">
                    <h2>系统统计</h2>
                    <div class="stats-grid">
                        <div class="stat-card compact">
                            <h4>总请求数</h4>
                            <div class="stat-value">{{ stats.requestCount || 0 }}</div>
                        </div>
                        <div class="stat-card clickable" @click="openConfigDrawer">
                            <h4>配置数量</h4>
                            <div class="stat-value">{{ stats.configCount || 0 }}</div>
                            <div class="stat-hint">点击编辑配置</div>
                        </div>
                        <div class="stat-card clickable" @click="openFilterDrawer">
                            <h4>请求过滤</h4>
                            <div class="stat-value">{{ stats.filterCount || 0 }}</div>
                            <div class="stat-hint">点击编辑过滤</div>
                        </div>
                        <div class="stat-card clickable usage-card" @click="openUsageDrawer">
                            <h4>Token 使用</h4>
                            <div class="stat-value">{{ usageSummary.formattedTotals.total || '0' }}</div>
                            <div class="stat-hint">点击查看明细</div>
                        </div>
                    </div>
                </section>

                <!-- 实时请求 -->
                <section class="realtime-section">
                    <div class="realtime-header">
                        <h2>实时请求</h2>
                        <div class="connection-status">
                            <span v-for="(connected, service) in connectionStatus" :key="service"
                                  :class="['status-indicator-small', connected ? 'connected' : 'disconnected']">
                                {{ service }}: {{ connected ? '已连接' : '断开' }}
                            </span>
                            <el-button type="text" @click="reconnectRealtime" size="small">
                                重连
                            </el-button>
                        </div>
                    </div>

                    <div class="realtime-container">
                        <div class="realtime-table-header">
                            <span>发起时间</span>
                            <span>服务</span>
                            <span>状态</span>
                            <span>耗时</span>
                            <span>操作</span>
                        </div>

                        <div class="realtime-entries">
                            <div v-if="realtimeRequests.length === 0" class="no-realtime-requests">
                                <span>无实时请求</span>
                            </div>
                            <div v-else v-for="req in realtimeRequests.slice(0, 4)"
                                 :key="req.request_id"
                                 class="realtime-entry">
                                <span>{{ formatRealtimeTime(req.start_time) }}</span>
                                <span>{{ req.service }} [{{ req.channel }}]</span>
                                <span>
                                    <el-tag :type="getStatusDisplay(req.status).type" size="small">
                                        {{ getStatusDisplay(req.status).text }}
                                    </el-tag>
                                </span>
                                <span>{{ req.displayDuration }}ms</span>
                                <span>
                                    <el-button type="text" size="small" @click="showRealtimeDetail(req)">
                                        详情
                                    </el-button>
                                </span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 请求日志 -->
                <section class="logs-section">
                    <div class="logs-header">
                        <h2>最近请求日志</h2>
                        <div class="logs-actions">
                            <el-button type="success" @click="viewAllLogs" size="small">
                                查看所有日志
                            </el-button>
                            <el-button type="danger" @click="clearAllLogs" size="small">
                                清空日志
                            </el-button>
                        </div>
                    </div>
                    <div class="logs-container">
                        <div class="logs-table">
                            <div class="log-header">
                                <span>时间</span>
                                <span>服务</span>
                                <span>URL</span>
                                <span>状态</span>
                                <span>耗时</span>
                                <span>Usage</span>
                                <span>操作</span>
                            </div>
                            <div class="log-entries" v-loading="logsLoading">
                                <div v-if="logs.length === 0" class="log-entry loading">
                                    <span>{{ logsLoading ? '加载日志数据...' : '暂无日志数据' }}</span>
                                </div>
                                <div v-else v-for="log in logs" :key="log.id || log.timestamp" class="log-entry">
                                    <span>{{ formatTimestamp(log.timestamp) }}</span>
                                    <span :title="formatChannelName(log.channel)" style="white-space: pre-line;">{{ formatServiceWithChannel(log.service, log.channel) }}</span>
                                    <span :title="log.path">{{ formatMethodWithURL(log.method, log.path) }}</span>
                                    <span>
                                        <el-tag 
                                            :type="getStatusTagType(log.status_code)"
                                            size="small">
                                            {{ log.status_code || '-' }}
                                            
                                        </el-tag>
                                    </span>
                                    <span>{{ log.duration_ms ? `${log.duration_ms}ms` : '-' }}</span>
                                    <span class="usage-cell" :title="formatUsageSummary(log.usage, log.service)">
                                        {{ formatUsageSummary(log.usage, log.service) }}
                                    </span>
                                    <span>
                                        <el-button 
                                            type="text" 
                                            size="small"
                                            @click="showLogDetail(log)">
                                            详情
                                        </el-button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- 鉴权设置抽屉 -->
        <el-drawer v-model="authSettingsVisible" title="鉴权与代理凭证设置" size="40%">
            <div style="padding:8px 0;">
                <h3>启用鉴权</h3>
                <el-checkbox v-model="authEnabled.ui">UI 面板</el-checkbox>
                <el-checkbox v-model="authEnabled.codex">Codex 代理</el-checkbox>
                <el-checkbox v-model="authEnabled.claude">Claude 代理</el-checkbox>
                <div style="margin-top:8px">
                    <el-switch v-model="separateAuth" active-text="分开鉴权（为各服务单独配置密钥）" inactive-text="使用共享密钥"></el-switch>
                    <div class="mode-tip" style="margin-top:6px;color:#909399;font-size:12px;">
                        {{ separateAuth ? '当前使用分开鉴权模式，将会禁止共享密钥请求（仅服务级密钥有效）' : '当前使用共享模式，将会禁止服务级密钥请求（仅共享密钥有效）' }}
                    </div>
                </div>
            </div>
            <el-divider></el-divider>
            <div>
                <div v-show="!separateAuth" style="margin-top:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <h4 style="margin:0;">共享密钥</h4>
                        <el-button size="small" type="primary" @click="()=>{ pendingAddService=null; addKeyDialogVisible = true }">新增密钥</el-button>
                    </div>
                    <div class="key-list" v-if="sharedKeys && sharedKeys.length">
                        <div class="key-header">
                            <span>备注</span>
                            <span>密钥</span>
                            <span>创建时间</span>
                            <span>操作</span>
                        </div>
                        <div class="key-entries">
                            <div class="key-entry" v-for="row in sharedKeys" :key="row.id">
                                <span class="key-col-remark">{{ row.remark || '-' }}</span>
                                <span class="key-col-value">{{ maskKey(row.value) }}</span>
                                <span class="key-col-time">{{ new Date((row.created_at||0)*1000).toLocaleString() }}</span>
                                <span class="key-col-actions">
                                    <el-button size="small" @click="copySharedKeyValue(row.id)">复制密钥</el-button>
                                    <el-button size="small" type="danger" :loading="deletingKeyId===row.id" @click="deleteSharedKey(row.id)">删除密钥</el-button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div v-else style="color:#909399;font-size:12px;">暂无密钥</div>
                </div>
                <el-dialog v-model="addKeyDialogVisible" title="新增密钥" width="400px">
                    <el-form :model="{remark: newKeyRemark}" label-width="80px">
                        <el-form-item label="备注">
                            <el-input v-model="newKeyRemark" placeholder="请输入密钥备注，例如：项目A"></el-input>
                        </el-form-item>
                    </el-form>
                    <template #footer>
                        <span class="dialog-footer">
                            <el-button @click="addKeyDialogVisible=false">取消</el-button>
                            <el-button type="primary" :loading="addingKeyLoading" @click="confirmAddKey">创建</el-button>
                        </span>
                    </template>
                </el-dialog>

                <!-- 分开鉴权下的服务级密钥列表 -->
                <div v-show="separateAuth" style="margin-top:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <h4 style="margin:0;">Claude 密钥</h4>
                        <el-button size="small" type="primary" @click="openAddServiceKey('claude')">新增密钥</el-button>
                    </div>
                    <div class="key-list" v-if="serviceKeys.claude && serviceKeys.claude.length">
                        <div class="key-header">
                            <span>备注</span>
                            <span>密钥</span>
                            <span>创建时间</span>
                            <span>操作</span>
                        </div>
                        <div class="key-entries">
                            <div class="key-entry" v-for="row in serviceKeys.claude" :key="row.id">
                                <span class="key-col-remark">{{ row.remark || '-' }}</span>
                                <span class="key-col-value">{{ maskKey(row.value) }}</span>
                                <span class="key-col-time">{{ new Date((row.created_at||0)*1000).toLocaleString() }}</span>
                                <span class="key-col-actions">
                                    <el-button size="small" @click="copyServiceKey('claude', row.id)">复制密钥</el-button>
                                    <el-button size="small" type="danger" :loading="deletingKeyId==='claude:'+row.id" @click="deleteServiceKey('claude', row.id)">删除密钥</el-button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div v-else style="color:#909399;font-size:12px;">暂无密钥</div>
                </div>

                <div v-show="separateAuth" style="margin-top:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <h4 style="margin:0;">Codex 密钥</h4>
                        <el-button size="small" type="primary" @click="openAddServiceKey('codex')">新增密钥</el按钮>
                    </div>
                    <div class="key-list" v-if="serviceKeys.codex && serviceKeys.codex.length">
                        <div class="key-header">
                            <span>备注</span>
                            <span>密钥</span>
                            <span>创建时间</span>
                            <span>操作</span>
                        </div>
                        <div class="key-entries">
                            <div class="key-entry" v-for="row in serviceKeys.codex" :key="row.id">
                                <span class="key-col-remark">{{ row.remark || '-' }}</span>
                                <span class="key-col-value">{{ maskKey(row.value) }}</span>
                                <span class="key-col-time">{{ new Date((row.created_at||0)*1000).toLocaleString() }}</span>
                                <span class="key-col-actions">
                                    <el-button size="small" @click="copyServiceKey('codex', row.id)">复制密钥</el-button>
                                    <el-button size="small" type="danger" :loading="deletingKeyId==='codex:'+row.id" @click="deleteServiceKey('codex', row.id)">删除密钥</el-button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div v-else style="color:#909399;font-size:12px;">暂无密钥</div>
                </div>
            </div>
            <el-divider></el-divider>
            <div>
                <h3>管理员账号</h3>
                <el-form label-width="120px">
                    <el-form-item label="用户名">
                        <el-input v-model="uiAdmin.username" placeholder="新的管理员用户名"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="uiAdmin.password" type="password" show-password placeholder="新的管理员密码（修改后需重新登录）"></el-input>
                    </el-form-item>
                </el-form>
            </div>
            <template #footer>
                <div style="flex: auto">
                    <el-button @click="closeAuthSettings">取消</el-button>
                    <el-button type="primary" @click="saveAuthSettings">保存</el-button>
                </div>
            </template>
        </el-drawer>

        <!-- 配置编辑抽屉 -->
        <el-drawer 
            v-model="configDrawerVisible" 
            title="配置文件编辑" 
            size="600px"
            class="config-drawer">
            
            <div class="config-tabs">
                <el-button 
                    :type="activeConfigTab === 'claude' ? 'primary' : ''"
                    @click="activeConfigTab = 'claude'"
                    size="small">
                    Claude 配置
                </el-button>
                <el-button 
                    :type="activeConfigTab === 'codex' ? 'primary' : ''"
                    @click="activeConfigTab = 'codex'"
                    size="small">
                    Codex 配置
                </el-button>
            </div>
            
            <div class="config-content">
                <div v-show="activeConfigTab === 'claude'" class="tab-panel">
                    <div class="config-editor">
                        <!-- 模式切换区域 -->
                        <div class="config-mode-tabs">
                            <el-button
                                :type="configEditMode === 'interactive' ? 'primary' : ''"
                                @click="configEditMode = 'interactive'"
                                size="small">
                                交互模式
                            </el-button>
                            <el-button
                                :type="configEditMode === 'json' ? 'primary' : ''"
                                @click="configEditMode = 'json'"
                                size="small">
                                JSON模式
                            </el-button>
                        </div>

                        <!-- 交互模式内容区 -->
                        <div v-show="configEditMode === 'interactive'" class="interactive-mode-container">
                            <div class="config-form-header">
                                <label>站点配置管理:</label>
                                <div class="config-actions">
                                    <el-button
                                        type="success"
                                        size="small"
                                        icon="el-icon-plus"
                                        @click="startAddingSite('claude')">添加站点
                                    </el-button>
                                    <el-button
                                        type="primary"
                                        size="small"
                                        @click="saveConfig"
                                        :loading="configSaving">
                                        保存配置
                                    </el-button>
                                </div>
                            </div>

                            <div class="config-sites-container">
                                <!-- 新增站点编辑器 -->
                                <div v-if="editingNewSite.claude" class="config-site-card new-site-editor">
                                    <div class="config-field">
                                        <label class="field-label">站点名称:</label>
                                        <el-input
                                            v-model="newSiteData.claude.name"
                                            placeholder="例如: OpenAI-GPT4"
                                            class="new-site-name-input"
                                            @keyup.enter="confirmAddSite('claude')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">目标地址:</label>
                                        <el-input
                                            v-model="newSiteData.claude.baseUrl"
                                            placeholder="例如: https://api.openai.com">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证方式:</label>
                                        <el-radio-group v-model="newSiteData.claude.authType">
                                            <el-radio-button label="auth_token">Auth Token</el-radio-button>
                                            <el-radio-button label="api_key">API Key</el-radio-button>
                                        </el-radio-group>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证密钥:</label>
                                        <el-input
                                            v-model="newSiteData.claude.authValue"
                                            :placeholder="newSiteData.claude.authType === 'auth_token' ? '认证令牌' : 'API密钥'"
                                            type="password"
                                            show-password>
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">激活状态:</label>
                                        <div class="field-control">
                                            <el-switch v-model="newSiteData.claude.active"></el-switch>
                                            <div class="config-actions-inline">
                                                <el-button @click="cancelAddSite('claude')" size="small">取消</el-button>
                                                <el-button type="primary" @click="confirmAddSite('claude')" size="small">确认</el-button>
                                                <el-button type="info" @click="testNewSiteConnection('claude')" size="small" plain>测试</el-button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 现有站点列表 -->
                                <div v-for="(site, index) in friendlyConfigs.claude" :key="index"
                                     :class="['config-site-card', { 'site-active': site.active }]">
                                    <div class="config-field">
                                        <label class="field-label">站点名称:</label>
                                        <el-input
                                            v-model="site.name"
                                            placeholder="站点名称"
                                            @input="syncFormToJson('claude')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">目标地址:</label>
                                        <el-input
                                            v-model="site.baseUrl"
                                            placeholder="目标站点地址"
                                            @input="syncFormToJson('claude')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证方式:</label>
                                        <el-radio-group
                                            v-model="site.authType"
                                            @change="syncFormToJson('claude')">
                                            <el-radio-button label="auth_token">Auth Token</el-radio-button>
                                            <el-radio-button label="api_key">API Key</el-radio-button>
                                        </el-radio-group>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证密钥:</label>
                                        <el-input
                                            v-model="site.authValue"
                                            :placeholder="site.authType === 'auth_token' ? '认证令牌' : 'API密钥'"
                                            type="password"
                                            show-password
                                            @input="syncFormToJson('claude')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">激活状态:</label>
                                        <div class="field-control">
                                            <el-switch
                                                v-model="site.active"
                                                @change="handleActiveChange('claude', index, $event)">
                                            </el-switch>
                                            <div class="config-actions-inline">
                                                <el-button
                                                    @click="removeConfigSite('claude', index)"
                                                    type="danger"
                                                    size="small">
                                                    删除
                                                </el-button>
                                                <el-button
                                                    @click="testSiteConnection('claude', index)"
                                                    type="info"
                                                    size="small"
                                                    plain>
                                                    测试
                                                </el-button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="config-form-help" v-if="friendlyConfigs.claude.length === 0 && !editingNewSite.claude">
                                    <p><em>暂无站点配置，点击"添加站点"按钮开始配置</em></p>
                                </div>
                            </div>
                        </div>

                        <!-- JSON模式内容区 -->
                        <div v-show="configEditMode === 'json'" class="json-mode-container">
                            <label>claude.json 配置内容:</label>
                            <el-input
                                v-model="configContents.claude"
                                type="textarea"
                                :rows="20"
                                placeholder="加载中..."
                                style="font-family: monospace;">
                            </el-input>
                            <div class="config-help">
                                <p><strong>示例结构:</strong></p>
                                <code>{
  "自定义站点名称": {
    "base_url": "目标站点地址",
    "auth_token": "令牌",
    "api_key": "有些站点使用x-api-key传递就放这里",
    "active": false
  }
}</code>
                            </div>
                            <div class="editor-actions">
                                <el-button
                                    type="primary"
                                    @click="saveConfig"
                                    :loading="configSaving"
                                    size="small">
                                    保存配置
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-show="activeConfigTab === 'codex'" class="tab-panel">
                    <div class="config-editor">
                        <!-- 模式切换区域 -->
                        <div class="config-mode-tabs">
                            <el-button
                                :type="configEditMode === 'interactive' ? 'primary' : ''"
                                @click="configEditMode = 'interactive'"
                                size="small">
                                交互模式
                            </el-button>
                            <el-button
                                :type="configEditMode === 'json' ? 'primary' : ''"
                                @click="configEditMode = 'json'"
                                size="small">
                                JSON模式
                            </el-button>
                        </div>

                        <!-- 交互模式内容区 -->
                        <div v-show="configEditMode === 'interactive'" class="interactive-mode-container">
                            <div class="config-form-header">
                                <label>站点配置管理:</label>
                                <div class="config-actions">
                                    <el-button
                                        type="success"
                                        size="small"
                                        icon="el-icon-plus"
                                        @click="startAddingSite('codex')">添加站点
                                    </el-button>
                                    <el-button
                                        type="primary"
                                        size="small"
                                        @click="saveConfig"
                                        :loading="configSaving">
                                        保存配置
                                    </el-button>
                                </div>
                            </div>

                            <div class="config-sites-container">
                                <!-- 新增站点编辑器 -->
                                <div v-if="editingNewSite.codex" class="config-site-card new-site-editor">
                                    <div class="config-field">
                                        <label class="field-label">站点名称:</label>
                                        <el-input
                                            v-model="newSiteData.codex.name"
                                            placeholder="例如: OpenAI-GPT4"
                                            class="new-site-name-input"
                                            @keyup.enter="confirmAddSite('codex')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">目标地址:</label>
                                        <el-input
                                            v-model="newSiteData.codex.baseUrl"
                                            placeholder="例如: https://api.openai.com">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证方式:</label>
                                        <el-radio-group v-model="newSiteData.codex.authType">
                                            <el-radio-button label="auth_token">Auth Token</el-radio-button>
                                            <el-radio-button label="api_key">API Key</el-radio-button>
                                        </el-radio-group>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证密钥:</label>
                                        <el-input
                                            v-model="newSiteData.codex.authValue"
                                            :placeholder="newSiteData.codex.authType === 'auth_token' ? '认证令牌' : 'API密钥'"
                                            type="password"
                                            show-password>
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">激活状态:</label>
                                        <div class="field-control">
                                            <el-switch v-model="newSiteData.codex.active"></el-switch>
                                            <div class="config-actions-inline">
                                                <el-button @click="cancelAddSite('codex')" size="small">取消</el-button>
                                                <el-button type="primary" @click="confirmAddSite('codex')" size="small">确认</el-button>
                                                <el-button type="info" @click="testNewSiteConnection('codex')" size="small" plain>测试</el-button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 现有站点列表 -->
                                <div v-for="(site, index) in friendlyConfigs.codex" :key="index"
                                     :class="['config-site-card', { 'site-active': site.active }]">
                                    <div class="config-field">
                                        <label class="field-label">站点名称:</label>
                                        <el-input
                                            v-model="site.name"
                                            placeholder="站点名称"
                                            @input="syncFormToJson('codex')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">目标地址:</label>
                                        <el-input
                                            v-model="site.baseUrl"
                                            placeholder="目标站点地址"
                                            @input="syncFormToJson('codex')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证方式:</label>
                                        <el-radio-group
                                            v-model="site.authType"
                                            @change="syncFormToJson('codex')">
                                            <el-radio-button label="auth_token">Auth Token</el-radio-button>
                                            <el-radio-button label="api_key">API Key</el-radio-button>
                                        </el-radio-group>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">认证密钥:</label>
                                        <el-input
                                            v-model="site.authValue"
                                            :placeholder="site.authType === 'auth_token' ? '认证令牌' : 'API密钥'"
                                            type="password"
                                            show-password
                                            @input="syncFormToJson('codex')">
                                        </el-input>
                                    </div>
                                    <div class="config-field">
                                        <label class="field-label">激活状态:</label>
                                        <div class="field-control">
                                            <el-switch
                                                v-model="site.active"
                                                @change="handleActiveChange('codex', index, $event)">
                                            </el-switch>
                                            <div class="config-actions-inline">
                                                <el-button
                                                    @click="removeConfigSite('codex', index)"
                                                    type="danger"
                                                    size="small">
                                                    删除
                                                </el-button>
                                                <el-button
                                                    @click="testSiteConnection('codex', index)"
                                                    type="info"
                                                    size="small"
                                                    plain>
                                                    测试
                                                </el-button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="config-form-help" v-if="friendlyConfigs.codex.length === 0 && !editingNewSite.codex">
                                    <p><em>暂无站点配置，点击"添加站点"按钮开始配置</em></p>
                                </div>
                            </div>
                        </div>

                        <!-- JSON模式内容区 -->
                        <div v-show="configEditMode === 'json'" class="json-mode-container">
                            <label>codex.json 配置内容:</label>
                            <el-input
                                v-model="configContents.codex"
                                type="textarea"
                                :rows="20"
                                placeholder="加载中..."
                                style="font-family: monospace;">
                            </el-input>
                            <div class="config-help">
                                <p><strong>示例结构:</strong></p>
                                <code>{
  "自定义站点名称": {
    "base_url": "目标站点地址",
    "auth_token": "令牌",
    "api_key": "有些站点使用x-api-key传递就放这里",
    "active": false
  }
}</code>
                            </div>
                            <div class="editor-actions">
                                <el-button
                                    type="primary"
                                    @click="saveConfig"
                                    :loading="configSaving"
                                    size="small">
                                    保存配置
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </el-drawer>

        <!-- 过滤器编辑抽屉 -->
        <el-drawer 
            v-model="filterDrawerVisible" 
            title="请求过滤器编辑" 
            size="700px"
            class="filter-drawer">
            
            <div class="config-content">
                <div class="tab-panel active">
                    <div class="filter-editor">
                        <label>过滤规则配置:</label>
                        <div class="filter-rules-container">
                            <div v-for="(rule, index) in filterRules" :key="index" class="filter-rule-row">
                                <el-input
                                    v-model="rule.source"
                                    placeholder="要匹配的文本"
                                    size="small"
                                    style="width: 180px">
                                </el-input>
                                <el-select 
                                    v-model="rule.op" 
                                    size="small"
                                    style="width: 100px; margin: 0 10px">
                                    <el-option label="替换" value="replace"></el-option>
                                    <el-option label="删除" value="remove"></el-option>
                                </el-select>
                                <el-input
                                    v-model="rule.target"
                                    placeholder="替换后的文本"
                                    :disabled="rule.op === 'remove'"
                                    size="small"
                                    style="width: 180px">
                                </el-input>
                                <el-button 
                                    @click="removeFilterRule(index)" 
                                    type="danger" 
                                    icon="el-icon-delete" 
                                    circle
                                    size="small">
                                </el-button>
                            </div>
                            <el-button 
                                @click="addFilterRule" 
                                type="success" 
                                size="small"
                                icon="el-icon-plus"
                                style="margin-top: 10px">
                                添加规则
                            </el-button>
                        </div>
                        <div class="filter-help">
                            <p><strong>使用说明:</strong></p>
                            <p>• 每行一个规则，按顺序执行</p>
                            <p>• 选择"替换"时，将source替换为target</p>
                            <p>• 选择"删除"时，将删除source匹配的内容</p>
                            <p>• 支持正则表达式</p>
                        </div>
                        <div class="editor-actions">
                            <el-button 
                                type="primary" 
                                @click="saveFilter" 
                                :loading="filterSaving"
                                size="small">
                                保存过滤规则
                            </el-button>
                            <el-button 
                                @click="loadFilter" 
                                size="small">
                                重新加载
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>
        </el-drawer>

        <!-- 日志详情侧边栏 -->
        <el-drawer
            v-model="logDetailVisible"
            title="请求日志详情"
            size="900px"
            class="log-detail-drawer">
            
            <div v-if="selectedLog" class="log-detail-content">
                <!-- Tab切换导航 -->
                <el-tabs v-model="activeLogTab" class="log-detail-tabs">
                    <!-- 基本信息Tab -->
                    <el-tab-pane label="基础" name="basic">
                        <div class="detail-section">
                            <div class="detail-basic-list">
                                <div class="detail-row">
                                    <span class="label">时间:</span>
                                    <span class="value">{{ selectedLog.timestamp || '-' }}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">服务:</span>
                                    <span class="value">{{ selectedLog.service || '-' }}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">渠道:</span>
                                    <span class="value">{{ formatChannelName(selectedLog.channel) }}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">方法:</span>
                                    <span class="value">{{ selectedLog.method || '-' }}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">状态码:</span>
                                    <span class="value">
                                        <el-tag :type="getStatusTagType(selectedLog.status_code)">
                                            {{ selectedLog.status_code || '-' }}
                                        </el-tag>
                                    </span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">耗时:</span>
                                    <span class="value">{{ selectedLog.duration_ms ? `${selectedLog.duration_ms}ms` : '-' }}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="label">请求路径:</span>
                                    <span class="value">
                                        <code class="path-code">{{ selectedLog.path || '-' }}</code>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="detail-section usage-section">
                            <h4>Usage 指标</h4>
                            <div class="usage-grid">
                                <div class="usage-item" v-for="(label, key) in usageMetricLabels" :key="key">
                                    <span class="usage-label">{{ label }}:</span>
                                    <span class="usage-value">{{ formatUsageValue(selectedLog.usage?.metrics?.[key] || 0) }}</span>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>

                    <!-- 转换前请求头Tab -->
                    <el-tab-pane label="headers" name="headers_before">
                        <div class="detail-section">
                            <div class="headers-content-flat">
                                <div v-if="!selectedLog.original_headers || Object.keys(selectedLog.original_headers).length === 0" class="no-headers">
                                    暂无请求头信息
                                </div>
                                <div v-else class="headers-list-flat">
                                    <div
                                        v-for="key in getSortedHeaderKeys(selectedLog.original_headers)"
                                        :key="key"
                                        class="header-item-flat">
                                        <span class="header-key-flat">{{ key }}:</span>
                                        <span class="header-value-flat">{{ selectedLog.original_headers[key] }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>

                    <!-- 转换后请求头Tab -->
                    <el-tab-pane label="headers(后)" name="headers_after">
                        <div class="detail-section">
                            <div class="headers-content-flat">
                                <div v-if="!selectedLog.target_headers || Object.keys(selectedLog.target_headers).length === 0" class="no-headers">
                                    暂无请求头信息
                                </div>
                                <div v-else class="headers-list-flat">
                                    <div
                                        v-for="key in getSortedHeaderKeys(selectedLog.target_headers)"
                                        :key="key"
                                        class="header-item-flat">
                                        <span class="header-key-flat">{{ key }}:</span>
                                        <span class="header-value-flat">{{ selectedLog.target_headers[key] }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>

                    <!-- 转换前请求体Tab -->
                    <el-tab-pane label="body" name="body_before">
                        <div v-if="!selectedLog.original_body" class="no-body">
                            暂无请求体内容
                        </div>
                        <div v-else class="request-body-fullscreen-container">
                            <div class="body-actions">
                                <el-button 
                                    size="small" 
                                    @click="copyToClipboard(decodedOriginalRequestBody)">
                                    复制内容
                                </el-button>
                                <el-button 
                                    size="small" 
                                    @click="formatOriginalRequestBody">
                                    格式化JSON
                                </el-button>
                            </div>
                            <el-input
                                v-model="decodedOriginalRequestBody"
                                type="textarea"
                                readonly
                                class="request-body-textarea-fullscreen">
                            </el-input>
                        </div>
                    </el-tab-pane>

                    <!-- 转换后请求体Tab -->
                    <el-tab-pane label="body(后)" name="body_after">
                        <div v-if="!selectedLog.filtered_body" class="no-body">
                            暂无请求体内容
                        </div>
                        <div v-else class="request-body-fullscreen-container">
                            <div class="body-actions">
                                <el-button 
                                    size="small" 
                                    @click="copyToClipboard(decodedRequestBody)">
                                    复制内容
                                </el-button>
                                <el-button 
                                    size="small" 
                                    @click="formatFilteredRequestBody">
                                    格式化JSON
                                </el-button>
                            </div>
                            <el-input
                                v-model="decodedRequestBody"
                                type="textarea"
                                readonly
                                class="request-body-textarea-fullscreen">
                            </el-input>
                        </div>
                    </el-tab-pane>

                    <!-- 响应数据Tab -->
                    <el-tab-pane label="响应" name="response">
                        <div v-if="!selectedLog.response_content" class="no-body">
                            暂无响应内容
                        </div>
                        <div v-else class="request-body-fullscreen-container">
                            <div class="body-actions">
                                <el-button
                                    size="small"
                                    @click="copyToClipboard(decodedResponseContent)">
                                    复制内容
                                </el-button>
                                <el-button
                                    size="small"
                                    @click="formatResponseContent">
                                    格式化JSON
                                </el-button>
                            </div>
                            <el-input
                                v-model="decodedResponseContent"
                                type="textarea"
                                readonly
                                class="request-body-textarea-fullscreen">
                            </el-input>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
        </el-drawer>

        <!-- 所有日志侧边栏 -->
        <el-drawer 
            v-model="allLogsVisible" 
            title="所有请求日志" 
            size="85%"
            class="all-logs-drawer">
            
            <div class="all-logs-content" v-loading="allLogsLoading">
                <div class="all-logs-stats">
                    <span>共 {{ allLogs.length }} 条日志记录</span>
                    <div class="stats-actions">
                        <el-button 
                            type="primary" 
                            size="small" 
                            @click="refreshAllLogs"
                            :loading="allLogsLoading">
                            刷新
                        </el-button>
                        <el-button 
                            type="danger" 
                            size="small" 
                            @click="clearAllLogs">
                            清空日志
                        </el-button>
                    </div>
                </div>
                
                    <div class="all-logs-table">
                        <div class="log-header">
                            <span>时间</span>
                            <span>服务</span>
                            <span>URL</span>
                            <span>状态</span>
                            <span>耗时</span>
                            <span>Usage</span>
                            <span>操作</span>
                        </div>
                        <div class="all-log-entries">
                            <div v-if="allLogs.length === 0" class="log-entry loading">
                                <span>{{ allLogsLoading ? '加载日志数据...' : '暂无日志数据' }}</span>
                            </div>
                            <div v-else v-for="log in allLogs" :key="log.id || log.timestamp" class="log-entry">
                                <span>{{ formatTimestamp(log.timestamp) }}</span>
                                <span :title="formatChannelName(log.channel)" style="white-space: pre-line;">{{ formatServiceWithChannel(log.service, log.channel) }}</span>
                                <span :title="log.path">{{ formatMethodWithURL(log.method, log.path) }}</span>
                                <span>
                                    <el-tag 
                                        :type="getStatusTagType(log.status_code)"
                                        size="small">
                                        {{ log.status_code || '-' }}
                                    </el-tag>
                                </span>
                                <span>{{ log.duration_ms ? `${log.duration_ms}ms` : '-' }}</span>
                                <span class="usage-cell" :title="formatUsageSummary(log.usage, log.service)">
                                    {{ formatUsageSummary(log.usage, log.service) }}
                                </span>
                                <span>
                                    <el-button 
                                        type="primary" 
                                        size="small"
                                        link
                                        @click="showLogDetail(log)">
                                        详情
                                    </el-button>
                                </span>
                        </div>
                    </div>
                </div>
            </div>
        </el-drawer>

        <!-- 模型选择弹框 -->
        <el-dialog
            v-model="modelSelectorVisible"
            title="选择模型进行测试"
            width="400px"
            @close="cancelModelSelection">
            <div class="model-selector-content">
                <el-form :model="testConfig" label-width="80px">
                    <el-form-item label="模型:">
                        <el-select
                            v-model="testConfig.model"
                            placeholder="请选择或输入模型名称"
                            style="width: 100%"
                            filterable
                            allow-create>
                            <el-option
                                v-for="model in getModelOptions(testConfig.service)"
                                :key="model.value"
                                :label="model.label"
                                :value="model.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item v-if="testConfig.service === 'codex'" label="推理等级:">
                        <el-select
                            v-model="testConfig.reasoningEffort"
                            placeholder="请选择推理等级"
                            style="width: 100%">
                            <el-option label="high" value="high"></el-option>
                            <el-option label="medium" value="medium"></el-option>
                            <el-option label="low" value="low"></el-option>
                            <el-option label="minimal" value="minimal"></el-option>
                        </el-select>
                    </el-form-item>
                </el-form>

                <!-- 测试结果显示区域 -->
                <div v-if="lastTestResult.status_code !== null || testingConnection" class="test-result-section" style="margin-top: 20px; border-top: 1px solid #e4e7ed; padding-top: 16px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #606266;">测试结果</h4>

                    <div v-if="testingConnection" style="text-align: center; padding: 20px;">
                        <el-icon class="is-loading" style="font-size: 20px; margin-bottom: 8px;"><Loading /></el-icon>
                        <div style="color: #909399;">正在测试连接...</div>
                    </div>

                    <div v-else-if="lastTestResult.status_code !== null">
                        <div class="test-result-summary">
                            <div class="result-item">
                                <span class="result-label">测试状态:</span>
                                <el-tag :type="lastTestResult.success ? 'success' : 'danger'" size="default">
                                    {{ lastTestResult.success ? '连接成功' : '连接失败' }}
                                </el-tag>
                            </div>
                            <div class="result-item">
                                <span class="result-label">状态码:</span>
                                <span class="result-value">{{ lastTestResult.status_code || '-' }}</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">目标URL:</span>
                                <span class="result-value">{{ lastTestResult.target_url || '-' }}</span>
                            </div>
                            <div v-if="lastTestResult.error_message" class="result-item">
                                <span class="result-label">错误信息:</span>
                                <span class="result-value error">{{ lastTestResult.error_message }}</span>
                            </div>
                        </div>

                        <div v-if="lastTestResult.status_code !== null" class="test-response-section" style="margin-top: 16px;">
                            <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #606266;">响应数据:</h5>
                            <el-input
                                v-model="lastTestResult.response_text"
                                type="textarea"
                                :rows="6"
                                readonly
                                placeholder="无响应数据">
                            </el-input>
                            <div class="response-actions" style="margin-top: 8px; text-align: right;">
                                <el-button size="small" @click="copyTestResult">复制响应</el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="cancelModelSelection">
                        {{ lastTestResult.status_code !== null ? '关闭' : '取消' }}
                    </el-button>
                    <el-button
                        v-if="lastTestResult.status_code === null"
                        type="primary"
                        @click="confirmModelSelection"
                        :loading="testingConnection">
                        开始测试
                    </el-button>
                    <el-button
                        v-else
                        type="primary"
                        @click="confirmModelSelection"
                        :loading="testingConnection">
                        重新测试
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- Usage详情抽屉 -->
        <el-drawer
            v-model="usageDrawerVisible"
            title="Token 使用详情"
            size="1000px"
            class="usage-drawer">
            <div class="usage-drawer-content" v-loading="usageDetailsLoading">
                <div class="usage-summary-card">
                    <h3>总体汇总</h3>
                    <div class="usage-summary-grid">
                        <div class="usage-summary-item" v-for="key in metricKeys" :key="key">
                            <span class="usage-label">{{ usageMetricLabels[key] }}:</span>
                            <span class="usage-value">{{ getUsageFormattedValue(usageDetails.totals, key) }}</span>
                        </div>
                    </div>
                </div>

                <div class="usage-service-section" v-for="(serviceData, serviceName) in usageDetails.services" :key="serviceName">
                    <div class="usage-service-header">
                        <h3>{{ serviceName }} CLI</h3>
                        <span class="usage-total">总计 {{ getUsageFormattedValue(serviceData.overall, 'total') }}</span>
                    </div>
                    <div class="usage-summary-grid service-overall">
                        <div class="usage-summary-item" v-for="key in metricKeys" :key="key">
                            <span class="usage-label">{{ usageMetricLabels[key] }}:</span>
                            <span class="usage-value">{{ getUsageFormattedValue(serviceData.overall, key) }}</span>
                        </div>
                    </div>
                    <div v-if="Object.keys(serviceData.channels).length" class="usage-channel-table">
                        <div class="usage-channel-header">
                            <span>目标站点</span>
                            <span v-for="key in metricKeys" :key="key">{{ usageMetricLabels[key] }}</span>
                        </div>
                        <div class="usage-channel-row" v-for="(channelData, channelName) in serviceData.channels" :key="channelName">
                            <span class="channel-name">{{ formatChannelName(channelName) }}</span>
                            <span v-for="key in metricKeys" :key="key">{{ getUsageFormattedValue(channelData, key) }}</span>
                        </div>
                    </div>
                    <div v-else class="usage-channel-empty">暂无渠道数据</div>
                </div>

                <div class="usage-drawer-actions">
                    <el-button type="primary" size="small" @click="loadUsageDetails" :loading="usageDetailsLoading">刷新</el-button>
                    <el-button type="danger" size="small" @click="clearUsageData">清空Token</el-button>
                    <el-button size="small" @click="closeUsageDrawer">关闭</el-button>
                </div>
            </div>
        </el-drawer>

        <!-- 实时请求详情抽屉 -->
        <el-drawer
            v-model="realtimeDetailVisible"
            title="实时请求详情"
            size="800px"
            direction="rtl"
            class="realtime-detail-drawer">

            <div v-if="selectedRealtimeRequest" class="realtime-detail-content">
                <div class="detail-basic-info">
                    <el-descriptions title="基本信息" :column="2" border>
                        <el-descriptions-item label="请求ID">
                            {{ selectedRealtimeRequest.request_id }}
                        </el-descriptions-item>
                        <el-descriptions-item label="服务">
                            {{ selectedRealtimeRequest.service }}
                        </el-descriptions-item>
                        <el-descriptions-item label="渠道">
                            {{ selectedRealtimeRequest.channel }}
                        </el-descriptions-item>
                        <el-descriptions-item label="状态">
                            <el-tag :type="getStatusDisplay(selectedRealtimeRequest.status).type">
                                {{ getStatusDisplay(selectedRealtimeRequest.status).text }}
                            </el-tag>
                        </el-descriptions-item>
                        <el-descriptions-item label="方法">
                            {{ selectedRealtimeRequest.method }}
                        </el-descriptions-item>
                        <el-descriptions-item label="路径">
                            {{ selectedRealtimeRequest.path }}
                        </el-descriptions-item>
                        <el-descriptions-item label="耗时">
                            {{ selectedRealtimeRequest.displayDuration }}ms
                        </el-descriptions-item>
                        <el-descriptions-item label="状态码" v-if="selectedRealtimeRequest.status_code">
                            {{ selectedRealtimeRequest.status_code }}
                        </el-descriptions-item>
                        <el-descriptions-item label="开始时间">
                            {{ formatRealtimeTime(selectedRealtimeRequest.start_time) }}
                        </el-descriptions-item>
                        <el-descriptions-item label="目标URL" v-if="selectedRealtimeRequest.target_url">
                            {{ selectedRealtimeRequest.target_url }}
                        </el-descriptions-item>
                    </el-descriptions>
                </div>

                <div class="detail-response-section">
                    <h4>实时响应流</h4>
                    <div class="response-stream-container">
                        <div class="response-stream-content">
                            <pre v-if="selectedRealtimeRequest.responseText">{{ selectedRealtimeRequest.responseText }}</pre>
                            <div v-else class="no-response">暂无响应数据...</div>
                        </div>
                    </div>
                </div>

                <div class="detail-headers-section" v-if="selectedRealtimeRequest.request_headers">
                    <h4>请求头</h4>
                    <div class="headers-content">
                        <pre>{{ JSON.stringify(selectedRealtimeRequest.request_headers, null, 2) }}</pre>
                    </div>
                </div>
            </div>
        </el-drawer>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2.8.0/dist/index.full.js"></script>
    <!-- 实时连接管理器 -->
    <script src="/static/realtime-manager.js"></script>
    <!-- 应用逻辑 -->
    <script src="/static/app.js"></script>
    
    <script>
    // 确保库加载完成后再初始化
    window.addEventListener('DOMContentLoaded', function() {
        // 检查Vue和Element Plus是否加载成功
        if (typeof Vue === 'undefined') {
            console.error('Vue未加载成功');
            document.getElementById('app').innerHTML = '<h1>Vue加载失败，请检查网络连接</h1>';
            return;
        }
        
        if (typeof ElementPlus === 'undefined') {
            console.error('Element Plus未加载成功');
            document.getElementById('app').innerHTML = '<h1>Element Plus加载失败，请检查网络连接</h1>';
            return;
        }
        
        console.log('Vue和Element Plus已加载，app.js应该会自动初始化应用');
    });
    </script>
</body>
</html>
